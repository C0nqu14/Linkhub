{% extends 'base.html' %}
{% block content %}
<div class="row g-4 py-4">
    <div class="col-lg-8">
        <div class="glass-card overflow-hidden mb-4 shadow-lg">
            <div class="position-relative">
                <img src="{{ app.image_url }}" class="w-100" style="height: 350px; object-fit: cover; filter: brightness(0.6);">
                <div class="position-absolute bottom-0 start-0 p-4 w-100" style="background: linear-gradient(transparent, rgba(5,5,5,1));">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="/" class="text-accent text-decoration-none small">Início</a></li>
                            <li class="breadcrumb-item active text-secondary small" aria-current="page">{{ app.category }}</li>
                        </ol>
                    </nav>
                    <h1 class="fw-extrabold text-white mb-0 display-5">{{ app.title }}</h1>
                    <span class="badge bg-dark border border-secondary text-secondary mt-2">Versão {{ app.version }}</span>
                </div>
            </div>

            <div class="p-4 bg-card">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div class="d-flex align-items-center bg-black bg-opacity-50 rounded-pill p-1 border border-secondary shadow-sm">
                        <a href="/vote/{{ app.id }}/1" class="btn btn-link text-decoration-none p-2 hover-up" title="Útil">
                            <i class="bi bi-arrow-up-circle-fill fs-3 text-accent"></i>
                        </a>
                        <span class="fw-bold px-2 fs-5" style="min-width: 40px; text-align: center;">{{ app.votes }}</span>
                        <a href="/vote/{{ app.id }}/-1" class="btn btn-link text-decoration-none p-2 hover-down" title="Não útil">
                            <i class="bi bi-arrow-down-circle-fill fs-3 text-secondary"></i>
                        </a>
                    </div>
                    
                    <a href="{{ app.download_url }}" target="_blank" class="btn btn-primary btn-lg px-5 fw-bold shadow">
                        <i class="bi bi-cloud-arrow-down-fill me-2"></i>OBTER AGORA
                    </a>
                </div>

                <h6 class="small-caps text-accent mb-3 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Sobre este projeto</h6>
                <p class="text-secondary lh-lg mb-0" style="white-space: pre-line;">{{ app.description }}</p>
            </div>
        </div>

        <div class="glass-card p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0"><i class="bi bi-chat-right-text-fill me-2 text-accent"></i>Comunidade</h5>
                <span class="text-secondary small">{{ app.comments|length }} comentários</span>
            </div>

            {% if current_user.is_authenticated %}
            <form method="POST" class="mb-5">
                <div class="d-flex gap-3">
                    <img src="{{ current_user.get_avatar() }}" class="rounded-circle border border-secondary" width="40" height="40">
                    <div class="flex-grow-1">
                        <textarea name="content" class="form-control bg-dark border-secondary text-white mb-2 shadow-none" rows="3" placeholder="Escreve o teu comentário..." required></textarea>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold">PUBLICAR</button>
                        </div>
                    </div>
                </div>
            </form>
            {% else %}
            <div class="alert bg-dark border-secondary text-center py-4 mb-5">
                <p class="text-secondary mb-2 small">Queres participar na discussão?</p>
                <a href="/login" class="btn btn-outline-primary btn-sm px-4 fw-bold">Entrar na Conta</a>
            </div>
            {% endif %}

            <div class="comment-list">
                {% for comment in app.comments if not comment.parent_id %}
                <div class="d-flex gap-3 mb-4 animate-fade-in">
                    <img src="{{ comment.user.get_avatar() }}" class="rounded-circle border border-secondary shadow-sm" width="45" height="45">
                    
                    <div class="flex-grow-1">
                        <div class="bg-black bg-opacity-40 p-3 rounded-4 border border-secondary hover-border">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold text-accent small">u/{{ comment.user.username }}</span>
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    <i class="bi bi-clock me-1"></i>{{ comment.created_at.strftime('%d %b, %H:%M') }}
                                </small>
                            </div>
                            <p class="m-0 small text-light lh-base">{{ comment.content }}</p>
                            
                            <div class="mt-3 d-flex gap-4">
                                <button class="btn btn-link btn-sm text-secondary p-0 text-decoration-none small fw-bold" 
                                        onclick="document.getElementById('reply-{{ comment.id }}').classList.toggle('d-none')">
                                    <i class="bi bi-reply-fill me-1"></i>RESPONDER
                                </button>
                                
                                <a href="/like_comment/{{ comment.id }}" class="btn btn-link btn-sm text-secondary p-0 text-decoration-none small fw-bold">
                                    <i class="bi bi-heart-fill me-1 {% if comment.likes > 0 %}text-danger{% endif %}"></i>
                                    {% if comment.likes > 0 %}{{ comment.likes }}{% endif %} REAGIR
                                </a>
                            </div>
                        </div>

                        <form id="reply-{{ comment.id }}" method="POST" class="d-none mt-3 animate-fade-in">
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <div class="input-group input-group-sm">
                                <input type="text" name="content" class="form-control bg-dark border-secondary text-white shadow-none" placeholder="Escreve uma resposta..." required>
                                <button class="btn btn-primary px-3 fw-bold">ENVIAR</button>
                            </div>
                        </form>

                        {% for reply in comment.replies %}
                        <div class="d-flex gap-2 mt-3 ps-3 border-start border-secondary border-opacity-50" style="border-width: 2px !important;">
                            <img src="{{ reply.user.get_avatar() }}" class="rounded-circle border border-secondary" width="30" height="30">
                            <div class="p-2 px-3 rounded-3 bg-dark bg-opacity-20 border border-secondary flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold text-info" style="font-size: 0.75rem;">u/{{ reply.user.username }}</span>
                                    <small class="text-muted" style="font-size: 0.6rem;">{{ reply.created_at.strftime('%H:%M') }}</small>
                                </div>
                                <p class="m-0 small text-secondary">{{ reply.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="glass-card p-4 mb-4 shadow-sm">
            <h6 class="small-caps text-secondary mb-3 text-uppercase" style="font-size: 0.65rem;">Publicado por</h6>
            <div class="d-flex align-items-center gap-3 mb-3">
                <img src="{{ app.author.get_avatar() }}" class="rounded-circle border border-accent p-1" width="55" height="55" style="object-fit: cover;">
                <div>
                    <h6 class="m-0 fw-bold text-white">{{ app.author.username }}</h6>
                    <div class="badge bg-accent bg-opacity-10 text-accent border border-accent border-opacity-25 mt-1">
                        <i class="bi bi-lightning-charge-fill me-1"></i>{{ app.author.karma }} Karma
                    </div>
                </div>
            </div>
            <hr class="border-secondary my-3 opacity-25">
            <div class="text-center">
                <small class="text-muted" style="font-size: 0.65rem;">Membro Ativo LinkHub</small>
            </div>
        </div>

        <div class="p-4 rounded-4 border border-danger border-opacity-25 bg-danger bg-opacity-10 text-center shadow-sm">
            <i class="bi bi-shield-fill-exclamation fs-2 text-danger mb-2 d-block"></i>
            <h6 class="fw-bold text-white">Segurança</h6>
            <p class="text-secondary small mb-3">Detetaste malware ou links quebrados neste projeto?</p>
            <a href="/report/{{ app.id }}" class="btn btn-outline-danger btn-sm w-100 fw-bold py-2">
                <i class="bi bi-flag-fill me-2"></i>DENUNCIAR POST
            </a>
        </div>
    </div>
</div>

<style>
    .hover-border:hover { border-color: var(--accent) !important; transition: 0.3s; }
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .hover-up:hover i { color: #00ff88 !important; transform: scale(1.1); transition: 0.2s; }
    .hover-down:hover i { color: #ff4444 !important; transform: scale(1.1); transition: 0.2s; }
    
    .breadcrumb-item + .breadcrumb-item::before { color: #6c757d; }
    .small-caps { font-weight: 800; letter-spacing: 0.5px; }
</style>
{% endblock %}